# Author: Brady M. Chisholm
# University of Minnesota Twin Cities
# Department of Psychology
```{r}
getRData <- function(data) {
if (data == 1 ){

# libraries
library(R.matlab)   # To read .mat data files
library(mgcv)       # For GAMM analysis
library(knitr)      # purl(); source .Rmd code for callings functions   

# get subjID list 
purl("M:/Lab_Shared/Brady_C/Projects/pupilEEG_fatigue/statistics/scripts/getSubjID_RV.Rmd", output = "getSubjID_RV.R")
source("getSubjID_RV.R")
subjIDS <- getSubjList(1)

# Base data directory
base_dir <- "M:/Lab_Shared/Juraj/SpeechEEG_SentencesWithPupillometry/data"

# store downsampled data 
downSampDir <- "M:/Lab_Shared/Brady_C/Projects/pupilEEG_fatigue/statistics/scripts/downSampDat"

# try to preallocate space for effeciency 
  subject_data <- vector("list", length(subjIDS))
  names(subject_data) <- subjIDS

  # prep bookkeeping table for eye data used 
  eyeUsed_Data <- data.frame(
  subject = subjIDS,
  eyeUsed = rep(NA, length(subjIDS)),
  stringsAsFactors = FALSE
)
  
## subj loop 
  for (subj in subjIDS) {
  # construct file path for this subj .
  file_path <- file.path(base_dir, subj, "eyeTrack", "processed", paste0(subj, "_preprocPupilData.mat"))
  
  # existence check 
  if (!file.exists(file_path)) {
  warning("File does not exist for subject: ", subj)
  next
  }

  # get .mat data file.
mat_data <- readMat(file_path)
  
  # check condOrder existance, else NA & quit 
  if ("condOrder" %in% names(mat_data)) {
  condOrder <- mat_data$condOrder
  } else {
  warning("Subject ", subj, ": Variable 'condOrder' not found in the .mat file.")
  stop() # if no condOrder exists, consider it a fatal error and stop 
  geterrmessage() 
  }
  
  # existence check 
  if (!"allDat" %in% names(mat_data)) {
  warning("Subject ", subj, ": Variable 'allDat' not found in the .mat file.")
  next
  }
  
  # Extract "allDat" (exp [200 x 2 x 6000])
  allDat <- mat_data$allDat
  
  #NaN mean avg
  validityVals <- colMeans(mat_data$allValidityPercentage, na.rm = TRUE)
  
  # opt to better eye 
  if(validityVals[1] > validityVals[2]){
  pupilData <- allDat[,1,] 
  eyeUsed <- "Left"
  }else{
  pupilData <- allDat[,2,] 
  eyeUsed <- "Right"
  }    
eyeUsed_Data[eyeUsed_Data$subject == subj, "eyeUsed"] <- eyeUsed
  
    # Check dimensions of "allDat"
if (!all(dim(pupilData) == c(200, 6000))) {
warning("Subject ", subj, ": 'allDat' dims != [200 x 2 x 6000]")
}

  # check condOrder var
if (is.null(mat_data$condOrder) || any(is.na(mat_data$condOrder))) {
  warning("Subject ", subj, ": condOrder not found or contains NA/NaN values.")
  stop()
} else {
  condOrder <- mat_data$condOrder
}
  
  # Store avg data and condition order for this subj 
  subject_data[[subj]] <- list(pupilData = pupilData, condOrder = condOrder)
  }
  
  # print dims of avg subj data
  for (subj in names(subject_data)) {
  dims <- paste(dim(subject_data[[subj]]$averaged), collapse = " x ")
  message("Subject: ", subj, " - Averaged data dimensions: ", dims)
  }
  
  # Return list w/ avg data and condOrder
  return(subject_data)
} 
else {
stop("Data value not recognized. Please provide a valid data input.")
  geterrmessage()
}}
```