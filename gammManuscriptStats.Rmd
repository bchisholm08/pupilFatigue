# Author: Brady M. Chisholm
# University of Minnesota Twin Cities
# Department of Psychology

```{r}
library(knitr)      # purl(); source .Rmd code for callings functions  
library(mgcv)       # for gamm mods 
library(dplyr)      # data manipulations & formatting
library(tidyr)      # data manipulations & formatting
```

# source .Rmd function 
```{r}
purl("M:/Lab_Shared/Brady_C/Projects/pupilEEG_fatigue/statistics/scripts/getData_RV.Rmd",
     output = "getData_RV.R")
source("getData_RV.R")
```

```{r}
subjList <- getRData(1)
summary(subjList)
```

```{r}
all_subjects_data <- lapply(names(subjList), function(subj) {
  # Extract the averaged pupil data: a 200 x 6000 matrix
  avg_mat <- subjList[[subj]]$averaged  # dimensions: 200 x 6000
  n_trials <- nrow(avg_mat)
  n_timepoints <- ncol(avg_mat)
  
  # Convert matrix to a data frame with trial as row identifier.
  # The columns will be automatically named V1, V2, ..., V6000.
  df <- as.data.frame(avg_mat)
  df$trial <- 1:n_trials
  
  # reshape data
  tidy_df <- pivot_longer(df, cols = starts_with("V"), 
                          names_to = "time", values_to = "pupil")
  
  # Convert time var from "V1", "V2", ... to numeric
  tidy_df$time <- as.numeric(sub("V", "", tidy_df$time))
  
  # If condOrder exists and is a vector of length equal to number of trials,
  # then replicate its values for each time point per trial.
  condOrder <- subjList[[subj]]$condOrder
  if (!is.null(condOrder) && length(condOrder) == n_trials) {
    tidy_df$condOrder <- rep(condOrder, each = n_timepoints)
  } else {
    tidy_df$condOrder <- NA
  }
  # Add subj id 
  tidy_df$subject <- subj
  
  return(tidy_df)
})
```

# concat subjs and summarize data  
```{r}
# Combine all subjects into one tidy data frame
tidy_data <- bind_rows(all_subjects_data)

# Take a look at the structure of the tidy data
summary(tidy_data)
head(tidy_data)
```
# note: data is almost 2gb, and is very slow. need parallel computing or something to speed up
```{r}
datSummary <- ggplot(tidy_data)
```

# GAMM models... 
```{r}
# Model: pupil predicted by: s(time) + condOrder w/ random intercept for subj

# If condOrder is categorical, maybe convert into a factor...
tidy_data$condOrder <- as.factor(tidy_data$condOrder)

# knots = 50
gamm_model <- gamm(pupil ~ s(time, k = 50) + condOrder,
                   random = list(subject = ~1),
                   data = tidy_data)

# summary of GAM model
summary(gamm_model$gam)
```


