# Author: Brady M. Chisholm
# University of Minnesota Twin Cities
# Department of Psychology

```{r}
library(knitr)      # purl(); source .Rmd code for callings functions  
library(mgcv)       # gamm mods 
library(dplyr)      # data manipulations & formatting
library(tidyr)      # data manipulations & formatting
library(ggplot2)    # figures
```

# source subj function and resample signal function 
```{r}
purl("M:/Lab_Shared/Brady_C/Projects/pupilEEG_fatigue/statistics/scripts/codebase/getData_RV.Rmd",
     output = "getData_RV.R")
source("getData_RV.R")

purl("M:/Lab_Shared/Brady_C/Projects/pupilEEG_fatigue/statistics/scripts/codebase/resampleSignal.Rmd",
     output = "resampleSignal.R")
source("resampleSignal.R")
```

```{r}
subjDataList <- getRData(1)
# assert(trialNumExpected, downSampledDatExpected)
summary(subjDataList)
# check dims returned from getRData against expected vals 
```

```{r gpt block gather data and combine}
# Combine the downsampled data from all subjects into one long-format data frame

all_data <- lapply(names(subjDataList), function(subj) {
  data_subj <- subjDataList[[subj]]
  
  # Extract the pupil data (trials x timepoints) and condition order (vector of length trials)
  pupilData <- data_subj$pupilData    
  condOrder <- data_subj$condOrder      
  
  # Convert the pupil matrix to a data frame;
  # using cbind() avoids the mutate() error when adding a vector column
  df <- as.data.frame(pupilData)
  df <- cbind(df, trial = 1:nrow(df), subject = subj, condOrder = condOrder)
  
  # Reshape from wide (each column = time point, named V1, V2, ...) to long format
  df_long <- pivot_longer(df,
                          cols = starts_with("V"),
                          names_to = "time",
                          values_to = "pupil")
  
  # Convert the time variable (from "V1", "V2", etc.) to a numeric index
  df_long$time <- as.numeric(gsub("V", "", df_long$time))
  
  return(df_long)
})

combined_data <- bind_rows(all_data)

# Inspect the structure and summary of the combined data
str(combined_data)
summary(combined_data)

# Save the combined data for future use if desired
saveRDS(combined_data, file = "combined_pupil_data.rds")

```

```{r summary statistics}
library(dplyr)

# Compute summary stats for each subject/trial (mean and SD of pupil diameter)
trial_stats <- combined_data %>%
  group_by(subject, trial) %>%
  summarize(mean_pupil = mean(pupil, na.rm = TRUE),
            sd_pupil   = sd(pupil, na.rm = TRUE),
            .groups = "drop")

# Compute overall summary stats across all subjects and trials
overall_stats <- combined_data %>%
  summarize(mean_pupil = mean(pupil, na.rm = TRUE),
            sd_pupil   = sd(pupil, na.rm = TRUE),
            min_pupil  = min(pupil, na.rm = TRUE),
            max_pupil  = max(pupil, na.rm = TRUE))

print(trial_stats)
print(overall_stats)

```

```{r plot mean pupil TS by subj}
library(ggplot2)

subject_time_series <- combined_data %>%
  group_by(subject, time) %>%
  summarize(mean_pupil = mean(pupil, na.rm = TRUE), .groups = "drop")

ggplot(subject_time_series, aes(x = time, y = mean_pupil, group = subject)) +
  geom_line(alpha = 0.5) +
  labs(title = "Mean Pupil Time Series per Subject",
       x = "Time (sample index)",
       y = "Mean Pupil Diameter")

```

```{r pupil measure distribution}
ggplot(combined_data, aes(x = pupil)) +
  geom_histogram(bins = 50, fill = "grey", color = "black") +
  labs(title = "Distribution of Pupil Measurements",
       x = "Pupil Diameter",
       y = "Frequency")

```

```{r mean pupil by condition}
condition_time_series <- combined_data %>%
  group_by(condOrder, time) %>%
  summarize(mean_pupil = mean(pupil, na.rm = TRUE), .groups = "drop")

ggplot(condition_time_series, aes(x = time, y = mean_pupil, color = as.factor(condOrder))) +
  geom_line() +
  labs(title = "Mean Pupil Time Series by Condition",
       x = "Time (sample index)",
       y = "Mean Pupil Diameter",
       color = "Condition")

```

